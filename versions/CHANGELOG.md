# 版本更新日志

记录每次参数调整的详细变更历史。

---

## v3.0 - 2025-10-04 🎉

### 重大更新：ROI检测与固定阈值

**状态**：✅ 已完成并验证成功  
**经历**：4轮迭代(R1-R4)，最终成功

### 核心创新

1. **ROI检测** - 自动定位白色陶瓷管区域
2. **固定阈值** - 替代Otsu，只检测暗色缺陷
3. **性能优化** - 修复blockproc参数错误

### 四轮迭代历程

#### v3.0-R1: 初始ROI + 局部Otsu (失败)
**配置**：
- ROI亮度阈值：0.30
- 局部Otsu，块大小64×64
- MorphOpenRadius: 5

**结果**：
- 缺陷率：64.69% ❌
- 质量分：47.4
- 问题：局部Otsu过度分割

#### v3.0-R2: 增大块大小 (更差)
**配置**：
- LocalBlockSize: 128×128
- ClipLimit: 0.015
- MorphOpenRadius: 3

**结果**：
- 缺陷率：72.80% ❌ (更差！)
- 质量分：45.5
- 问题：增大块反而更差

#### v3.0-R3: 改用全局Otsu (仍失败)
**配置**：
- 禁用局部Otsu
- 使用全局Otsu

**结果**：
- Otsu阈值：0.498
- 缺陷率：67.88% ❌
- 质量分：47.5
- 问题：Otsu阈值太高

#### v3.0-R4: 严格ROI + 固定阈值 (成功！) ✅
**配置**：
- ROI亮度阈值：0.30 → **0.50**
- 固定阈值：**0.25** (替代Otsu)
- MorphOpenRadius：3 → **8**

**单张测试结果**：
- ROI覆盖率：36.5%
- 缺陷率：**1.77%** ✅
- 质量分：**56.8** ✅
- 运行时间：**<30秒** ⚡

**批量测试结果（4张）**：
| 图片 | 缺陷率 | 质量分 |
|------|--------|--------|
| defect_01 | 1.77% | 56.8 |
| defect_02 | 1.70% | 56.8 |
| defect_03 | 1.66% | 55.8 |
| defect_04 | 1.89% | 56.6 |
| **平均** | **1.76%** | **56.5** |

### 关键改进

| 指标 | v2.2 | v3.0-R4 | 改进 |
|------|------|---------|------|
| **缺陷率** | ~50% | **1.76%** | 真实缺陷率 |
| **质量分** | 51.3 | **56.5** | +10% |
| **运行时间** | **~10小时** | **<30秒** | **提速1200倍** |

### 主要变更

#### 新增功能
1. **ROI检测** (`detect_ceramic_roi.m`)
   - 基于亮度阈值识别白色陶瓷管
   - 垂直位置约束
   - 形态学操作保持管子独立

2. **固定阈值策略**
   ```matlab
   fixedThreshold = 0.25;
   binaryGlobal = enhanced < fixedThreshold;
   ```

#### 参数调整
- `ROIBrightnessThreshold`: 0.30 → **0.50** (+67%)
- `fixedThreshold`: Otsu(0.498) → **0.25** (-50%)
- `MorphOpenRadius`: 3 → **8** (+167%)

#### 性能优化
- 修复blockproc的`'Overlap'`参数错误
- 改用正确的`'BorderSize'`参数
- ROI内禁用局部Otsu，使用固定阈值

### 技术突破

1. **blockproc参数修复**
   - ❌ 旧代码：`'Overlap'` (不存在的参数)
   - ✅ 新代码：`'BorderSize'` (正确参数)
   - 效果：避免回退到极慢的nlfilter

2. **ROI检测算法**
   - 只保留白色管子本体（亮度>0.50）
   - 排除管子之间的暗色缝隙
   - 提供准确的检测区域

3. **固定阈值优于Otsu**
   - Otsu受ROI内灰度分布影响
   - 固定阈值更稳定、可控
   - 只检测明显的暗色缺陷

### 关键洞察

#### 为什么v2.x的缺陷率是虚假的？
- v2.x：相对整张图（含背景55%）
- 实际管子缺陷率：57% / 45% ≈ 127%（不合理）
- v3.0：相对ROI（只有管子），1.76%才是真实值

#### 为什么局部Otsu在v3.0失败？
- v2.x：背景+管子，对比度大，需要局部适应
- v3.0：ROI内管子均匀，局部Otsu误判微小变化
- 解决：固定阈值更适合均匀区域

### 测试状态
✅ **已完成**
- 单张测试：成功
- 批量测试（4张）：成功
- 性能验证：提速1200倍
- 质量验证：缺陷率1.76%，质量分56.5

### 文档
- 完整技术文档：`versions/v3.0_roi_detection/VERSION_INFO.md`
- 成功总结：`matlab/V3_SUCCESS_SUMMARY.md`
- 问题诊断：`matlab/V3_PROBLEM_DIAGNOSIS.md`
- 性能分析：`PERFORMANCE_ISSUE_ANALYSIS.md`

### 使用说明
```matlab
% 批量处理
cd matlab
auto_run  % processMode = 'all'

% 查看结果
quick_view
```

---

## v2.2 - 2025-10-03

### 优化目标
继续降低缺陷覆盖率（v2.1为53.9%，目标<40%）

### 主要变更

#### 参数调整
- `LocalBlockSize`: [256 256] → [384 384] (+50%)
- `LocalOverlap`: [64 64] → [96 96] (+50%)
- `MorphOpenRadius`: 3 → 5 (+67%)
- `ClipLimit`: 0.02 → 0.025 (+25%)

#### 优化原因
基于v2.1测试结果：圆形问题已解决（↓90%），但缺陷率仍高（53.9%）

### 预期效果
- 缺陷覆盖率：53.9% → <40%
- 圆形数量：保持<50
- 质量评分：50.4 → >55

### 测试结果
✅ 已测试（2025-10-04）
- 缺陷覆盖率：53.9% → 50.7% (↓6.0%)
- 圆形数量：37 → 46 (+24%，略有回升)
- 质量评分：50.4 → 51.3 (↑1.8%)

**成果**：缺陷率持续降低，质量分提升  
**问题**：圆形数量略有回升，缺陷率仍>50%

### 测试状态
🔄 建议测试全局Otsu对比

---

## v2.1 - 2025-10-02

### 优化目标
解决大尺寸图像（6000×8000）检测问题

### 测试结果
✅ 已测试（2025-10-03）
- 缺陷覆盖率：57.0% → 53.9% (↓5.3%)
- 圆形数量：353 → 36 (↓90%) ✅
- 质量评分：47.7 → 50.4 (↑5.7%)
- 直线数量：111 → 62 (↓44%)

**成果**：圆形误检问题基本解决  
**问题**：缺陷率仍需继续优化

### 主要变更

#### 参数调整
- `LocalBlockSize`: [64 64] → [256 256] (+300%)
- `CircleSensitivity`: 0.9 → 0.85 (-5.6%)
- `ClipLimit`: 0.015 → 0.02 (+33%)
- `CircleRadius`: [6 40] → [8 30] (范围缩小)
- `NumTiles`: [8 8] → [16 16] (×2)
- `MorphOpenRadius`: 2 → 3 (+50%)
- `LineFillGap`: 10 → 15 (+50%)
- `LineMinLength`: 30 → 50 (+67%)
- `CircleEdgeThreshold`: 0.1 → 0.15 (+50%)

#### 优化原因
1. **LocalBlockSize增大**：适配大尺寸图像，解决57%缺陷覆盖率过高
2. **CircleSensitivity降低**：减少350+圆形误检
3. **ClipLimit提高**：改善-24%对比度问题

### 预期效果
- 缺陷覆盖率：57% → <20%
- 圆形数量：353 → <150
- 质量评分：47.7 → >60
- 对比度：-24% → >5%

### 测试状态
⏳ 待测试

---

## v2.0 - 2025-10-02

### 版本说明
初始基线版本

### 检测结果
- 缺陷覆盖率：57.0%（过高）
- 圆形数量：353个（过多）
- 质量评分：47.7（偏低）
- 对比度改善：-24%（为负）

### 发现的问题
1. ⚠️ 缺陷率过高：正常纹理被误判
2. ⚠️ 圆形过多：噪声被误判为圆形
3. ⚠️ 质量分低：检测效果不理想
4. ⚠️ 对比度差：CLAHE参数不合适

### 改进方向
需要优化参数以适配大尺寸图像

---

## 版本管理规范

### 何时创建新版本
- 重大参数调整（影响3个以上参数）
- 检测结果有显著变化
- 针对特定问题的优化方案

### 版本命名规范
`vX.Y_description`
- X: 主版本号（重大更新）
- Y: 次版本号（优化调整）
- description: 简短描述

### 必须保存的内容
1. 参数配置文件
2. 检测结果CSV
3. 版本说明文档
4. 对比分析数据

### 使用create_version创建新版本

```matlab
cd matlab
create_version('v2.2_my_optimization', '优化边缘检测参数');
```

