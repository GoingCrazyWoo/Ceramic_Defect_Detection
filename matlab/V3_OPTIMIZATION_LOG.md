# v3.0优化日志

## 第一轮测试结果（2025-10-04 06:46）

### 配置
```matlab
LocalBlockSize: [64 64]
LocalOverlap: [16 16]
ClipLimit: 0.025
MorphOpenRadius: 5
ROIBrightnessThreshold: 0.30
ROIHeightRange: [0.1, 0.9]
```

### 结果（20250929_defect_01.jpg）
| 指标 | 数值 | 评价 |
|------|------|------|
| ROI覆盖率 | 49.0% | ✅ 良好 |
| 缺陷覆盖率（相对ROI） | 64.69% | ❌ **过高** |
| 检测直线数 | 78 | ⚠️ 偏多 |
| 检测圆形数 | 10 | ✅ 合理 |
| 质量评分 | 47.4/100 | ❌ **偏低** |
| 运行时间 | ~3分钟 | ✅ 快速 |

### 问题分析
1. **缺陷率过高（64.69%）** - 局部Otsu块太小（64×64），把管子的正常纹理误判为缺陷
2. **质量评分低（47.4）** - 被高缺陷率拉低
3. **直线数偏多（78）** - 可能检测到了管子边缘和纹理

### 优化方案
**调整参数：**
- `LocalBlockSize`: [64 64] → **[128 128]** （关键！减少过度分割）
- `LocalOverlap`: [16 16] → **[32 32]** （配合块大小）
- `ClipLimit`: 0.025 → **0.015** （降低对比度增强）
- `MorphOpenRadius`: 5 → **3** （加强去噪）

**预期改进：**
- 缺陷率：64.69% → **25-35%**
- 质量评分：47.4 → **60-70**
- 运行时间：3分钟 → **5-10分钟**

---

## 第二轮测试（待运行）

**配置：**
```matlab
LocalBlockSize: [128 128]  ← 增大
LocalOverlap: [32 32]      ← 增大
ClipLimit: 0.015           ← 降低
MorphOpenRadius: 3         ← 降低
```

**目标：**
- ✅ 保持快速运行（<10分钟）
- ✅ 降低缺陷率到合理范围（20-40%）
- ✅ 提升质量评分（>60）
- ✅ 保持ROI检测效果

---

## 参数调整逻辑

### LocalBlockSize的选择

**原理：**
- 局部Otsu用不同的块大小计算阈值
- 块太小：把正常纹理误判为缺陷（过度分割）
- 块太大：错过小缺陷（欠分割）

**图像尺寸考虑：**
```
原图：6000×8000 = 48M像素
ROI：49% = 23.52M像素（约4898×4800）

块大小对比：
- [64, 64]: 77×75 = 5775块（太多！过度分割）
- [128, 128]: 39×38 = 1482块（合理）
- [256, 256]: 20×19 = 380块（偏少，但可能漏检）
```

**v3.0最优选择：128×128**
- 平衡速度和质量
- 足够大以避免误判纹理
- 足够小以检测真实缺陷

### ClipLimit的影响

**原理：**
- CLAHE的对比度限制参数
- 太高：放大微小纹理差异，导致误检
- 太低：对比度不足，漏检真实缺陷

**v2.x的演变：**
```
v2.0: 0.015 → 缺陷率57%（整张图）
v2.1: 0.020 → 缺陷率51%
v2.2: 0.025 → 缺陷率49%
v3.0: 0.025 + ROI → 缺陷率64.69%（相对ROI，过高！）
```

**v3.0优化：0.015**
- 回到v2.0的值
- 配合ROI，应该能达到合理的缺陷率

### MorphOpenRadius的作用

**原理：**
- 形态学开运算去除小噪点
- 太大：可能去除小缺陷
- 太小：保留过多噪点

**v3.0优化：3**
- 降低到3（从5）
- 加强去噪，减少误检

---

## 性能对比表

| 版本 | BlockSize | 缺陷率 | 质量分 | 时间 | 备注 |
|------|-----------|--------|--------|------|------|
| v2.0 | 64×64 | 57% | ~65 | <5分钟 | 整张图，基准 |
| v2.1 | 256×256 | 51% | ~72 | ~20分钟 | 整张图，质量提升 |
| v2.2 | 384×384 | 49% | ~75 | ~10小时 | 整张图，性能问题 |
| **v3.0-R1** | **64×64** | **64.69%** | **47.4** | **~3分钟** | ROI，过度检测 ❌ |
| **v3.0-R2** | **128×128** | **待测** | **待测** | **~5-10分钟** | ROI，优化版 ⭐ |

---

## 下一步

1. ✅ 已调整参数
2. ⏳ 等待运行 `auto_run` 验证第二轮优化
3. 📊 对比结果，评估改进效果
4. 🔄 如有必要，继续微调

---

**优化目标：**
- 缺陷率：20-40%（相对ROI）
- 质量评分：60-75
- 运行时间：<10分钟
- ROI效果：保持良好

